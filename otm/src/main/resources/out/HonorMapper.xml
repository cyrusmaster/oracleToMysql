<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.hzsun.zbp.tch.staff.dao.HonorDAO"> 
    <!--数据列表三元组映射--> 
    <resultMap id="SimpleTuple" type="com.hzsun.zbp.tch.staff.model.dto.SimpleTupleDTO"> 
        <result column="key" jdbcType="VARCHAR" property="key"></result> 
        <result column="item" jdbcType="VARCHAR" property="item"></result> 
        <result column="value" jdbcType="VARCHAR" property="value"></result> 
        <result column="total" jdbcType="VARCHAR" property="total"></result> 
    </resultMap> 
 
    <resultMap id="HonorDrillDownTeamDTO" type="com.hzsun.zbp.tch.staff.model.dto.ServicesDTO"> 
        <!-- 学术团体任职人数 --> 
        <result column="academic_organization_cnt" jdbcType="INTEGER" property="academicOrganizationCnt"></result> 
        <!-- 重要期刊任职人数 --> 
        <result column="important_journals_cnt" jdbcType="INTEGER" property="importantJournalsCnt"></result> 
    </resultMap> 
<!--map--> 
    <!--获取数据生成年份--> 
    <sql id="yearSql"> 
        (select (case cc 
            when 0 
                then (select data_date 
                      from ${tableName} 
                      where ltrim(DATE_FORMAT(to_number('${year}', '9999') - 1, '9999'))  = DATE_FORMAT(data_date, '%Y') 
                      order by data_date desc 
                      limit 1 offset 0) 
                else (select data_date 
                      from ${tableName} 
                      where '${year}' = DATE_FORMAT(data_date, '%Y') 
                      order by data_date desc 
                      limit 1 offset 0) end) as year 
        from (select count(*) cc 
                 from ${tableName} 
                 where '${year}' = DATE_FORMAT(data_date, '%Y') 
             ) t) 
    </sql> 
 
    <!--数据概览--> 
    <select id="getHonorOverview" resultMap="SimpleTuple"> 
        (select distinct awrd_rank_name                               as key, 
                awrd_name                                             as item, 
                sum(awrd_rank_cnt) over (partition by awrd_name)      as value, 
                sum(awrd_rank_cnt) over (partition by awrd_rank_name) as total 
        from ${tableName} 
        where data_date = <include refid="yearSql"/> 
        and awrd_rank_code in ('1', '2') 
        group by awrd_rank_name, awrd_name, awrd_rank_cnt 
        order by awrd_rank_name, awrd_name) 
        union all 
        (select '其他'                                                as key, 
                awrd_name                                             as item, 
                sum(awrd_rank_cnt) over (partition by awrd_name)      as value, 
                sum(awrd_rank_cnt) over () as total 
        from ${tableName} 
        where data_date = <include refid="yearSql"/> 
        and awrd_rank_code in ('3', '4') 
        order by awrd_rank_name, awrd_name) 
    </select> 
 
    <!--社会服务--> 
    <select id="getServices" resultMap="HonorDrillDownTeamDTO"> 
        select academic_organization_cnt,important_journals_cnt 
        from ${tableName} 
        where data_date = <include refid="yearSql"/> 
        offset 0 limit 1 
    </select> 
 
<!--sql--> 
 
</mapper> 
